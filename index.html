<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏ô‡∏°‡∏Ñ‡∏£‡∏Å</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:sans-serif;background:#fff3e0;margin:0;padding:15px}
h1{text-align:center;font-size:32px}
.item,.queue-box,.summary{background:#fff;border-radius:12px;padding:10px;margin-bottom:10px}
.row{display:flex;justify-content:space-between;align-items:center}
.btn{font-size:20px;padding:6px 12px;border:none;border-radius:8px}
.add{background:#ff9800;color:#fff}
.sub{background:#ccc}
.done{background:#e53935;color:#fff}
.price{font-weight:bold}
.qr{margin-top:8px;text-align:center}
hr{border:none;border-top:1px solid #ddd;margin:10px 0}
.big{font-size:22px}
</style>
</head>
<body>

<div id="app"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
/* ====== CONFIG ====== */
const flavors=["‡∏´‡∏≠‡∏°","‡πÄ‡∏ú‡∏∑‡∏≠‡∏Å","‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î","‡∏£‡∏ß‡∏°"];

/* ====== STORAGE ====== */
let prices=JSON.parse(localStorage.getItem("prices"))||{"‡∏´‡∏≠‡∏°":20,"‡πÄ‡∏ú‡∏∑‡∏≠‡∏Å":20,"‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î":20,"‡∏£‡∏ß‡∏°":25};
let queue=JSON.parse(localStorage.getItem("queue"))||[];
let summary=JSON.parse(localStorage.getItem("summary"))||{"‡∏´‡∏≠‡∏°":0,"‡πÄ‡∏ú‡∏∑‡∏≠‡∏Å":0,"‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î":0,"‡∏£‡∏ß‡∏°":0};
let qnum=JSON.parse(localStorage.getItem("qnum"))||1;

function save(){
  localStorage.setItem("prices",JSON.stringify(prices));
  localStorage.setItem("queue",JSON.stringify(queue));
  localStorage.setItem("summary",JSON.stringify(summary));
  localStorage.setItem("qnum",qnum);
}

/* ====== MODE CHECK ====== */
const params=new URLSearchParams(location.search);
const qview=params.get("queue");

/* ====== CUSTOMER MODE ====== */
if(qview){
  const q=queue.find(x=>x.num==qview);
  document.getElementById("app").innerHTML=
    `<h1>üç° ‡∏Ñ‡∏¥‡∏ß ${qview}</h1>`+
    (q?renderCustomer(q):"<p class='big'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏¥‡∏ß</p>");
  throw "customer";
}

function renderCustomer(q){
  let sum=0,html="<div class='summary big'>";
  for(let f in q.items){
    let m=q.items[f]*prices[f];
    sum+=m;
    html+=`${f} x ${q.items[f]} = ${m} ‡∏ö‡∏≤‡∏ó<br>`;
  }
  html+=`<hr><b>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${sum} ‡∏ö‡∏≤‡∏ó</b></div>`;
  return html;
}

/* ====== SELLER MODE ====== */
let current={"‡∏´‡∏≠‡∏°":0,"‡πÄ‡∏ú‡∏∑‡∏≠‡∏Å":0,"‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î":0,"‡∏£‡∏ß‡∏°":0};

function sellerUI(){
  let html=`<h1>üç° ‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏ô‡∏°‡∏Ñ‡∏£‡∏Å</h1><div id="order">`;
  flavors.forEach(f=>{
    html+=`
    <div class="item row">
      ${f}
      <div>
        <button class="btn sub" onclick="chg('${f}',-1)">‚àí</button>
        <b>${current[f]}</b>
        <button class="btn add" onclick="chg('${f}',1)">+</button>
      </div>
    </div>`;
  });
  html+=`</div>
  <button class="btn add" style="width:100%" onclick="addQueue()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏¥‡∏ß</button>
  <div id="list"></div>
  <div class="summary">
    <b>üí∏ ‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏Ñ‡∏¥‡∏ß</b><br>`+
    flavors.map(f=>`
    <div class="row">${f}
      <div>
        <button class="btn sub" onclick="chgPrice('${f}',-5)">‚àí</button>
        <span class="price">${prices[f]} ‡∏ö‡∏≤‡∏ó</span>
        <button class="btn add" onclick="chgPrice('${f}',5)">+</button>
      </div>
    </div>`).join("")+
  `<hr>
    <b>üìä ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</b><br>
    ${flavors.map(f=>`${f}: ${summary[f]} ‡∏Ñ‡∏¥‡∏ß`).join(" | ")}<br><br>
    <b>üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°:</b> <span id="total"></span> ‡∏ö‡∏≤‡∏ó<br>
    <b>üèÜ ‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î:</b> <span id="best"></span><br><br>
    <button class="btn" onclick="exportCSV()">üì§ Excel</button>
    <button class="btn" onclick="shareLine()">üì§ LINE</button>
    <button class="btn" onclick="resetDay()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
  </div>`;
  document.getElementById("app").innerHTML=html;
  render();
}

function chg(f,n){current[f]=Math.max(0,current[f]+n);sellerUI();}
function chgPrice(f,n){prices[f]=Math.max(0,prices[f]+n);save();sellerUI();}

function addQueue(){
  let items={},has=false;
  flavors.forEach(f=>{
    if(current[f]>0){items[f]=current[f];summary[f]+=current[f];has=true;}
  });
  if(!has){alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå");return;}
  queue.push({num:qnum,items});
  qnum++; current={"‡∏´‡∏≠‡∏°":0,"‡πÄ‡∏ú‡∏∑‡∏≠‡∏Å":0,"‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î":0,"‡∏£‡∏ß‡∏°":0};
  save(); sellerUI();
}

function render(){
  let total=0,max=0,best=[];
  queue.forEach((q,i)=>{
    let list="";
    for(let f in q.items) list+=`${f} x ${q.items[f]}<br>`;
    document.getElementById("list").innerHTML+=`
      <div class="queue-box">
        <b>‡∏Ñ‡∏¥‡∏ß ${q.num}</b><br>${list}
        <div class="qr" id="qr-${q.num}"></div>
        <button class="btn done" onclick="finish(${i})">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
      </div>`;
    setTimeout(()=>makeQR(q.num),0);
  });
  for(let f in summary){
    total+=summary[f]*prices[f];
    if(summary[f]>max){max=summary[f];best=[f];}
    else if(summary[f]==max&&max>0)best.push(f);
  }
  document.getElementById("total").innerText=total;
  document.getElementById("best").innerText=best.join(", ")||"-";
}

function finish(i){queue.splice(i,1);save();sellerUI();}

function makeQR(num){
  const url=location.origin+location.pathname+"?queue="+num;
  new QRCode(document.getElementById("qr-"+num),{text:url,width:120,height:120});
}

function exportCSV(){
  let csv="‡πÑ‡∏™‡πâ,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô,‡∏£‡∏≤‡∏Ñ‡∏≤,‡πÄ‡∏á‡∏¥‡∏ô\n";
  for(let f in summary) csv+=`${f},${summary[f]},${prices[f]},${summary[f]*prices[f]}\n`;
  let a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="kanomkrok_today.csv"; a.click();
}

function shareLine(){
  let t="‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏ô‡∏°‡∏Ñ‡∏£‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ\n";
  for(let f in summary) t+=`${f}: ${summary[f]} ‡∏Ñ‡∏¥‡∏ß\n`;
  t+=`‡∏£‡∏ß‡∏° ${document.getElementById("total").innerText} ‡∏ö‡∏≤‡∏ó`;
  navigator.share?navigator.share({text:t}):alert(t);
}

function resetDay(){
  if(!confirm("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà?"))return;
  queue=[]; summary={"‡∏´‡∏≠‡∏°":0,"‡πÄ‡∏ú‡∏∑‡∏≠‡∏Å":0,"‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î":0,"‡∏£‡∏ß‡∏°":0}; qnum=1;
  save(); sellerUI();
}

sellerUI();
</script>
</body>
</html>
